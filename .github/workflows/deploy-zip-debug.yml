name: Deploy dashboard-build-db.zip to GitHub Pages (robust)

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Runner info
        run: |
          echo "USER: $(whoami)"
          echo "PWD: $(pwd)"
          echo "Root listing:"
          ls -la

      - name: Ensure Python and unzip helper
        run: |
          echo "Python version:"
          python3 --version || python --version
          if ! command -v unzip >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y unzip

      - name: Confirm dashboard-build-db.zip exists and show zip listing
        run: |
          if [ ! -f "./dashboard-build-db.zip" ]; then
            echo "âŒ ERROR: dashboard-build-db.zip not found at repo root."
            exit 2
          fi
          echo "ğŸ“¦ dashboard-build-db.zip listing (head):"
          unzip -l dashboard-build-db.zip | sed -n '1,200p' || true

      - name: Extract only dashboard app to public
        id: extract_dashboard
        run: |
          python3 - <<'PY'
          import zipfile, os, sys, shutil

          root = os.getcwd()
          zip_path = os.path.join(root, "dashboard-build-db.zip")
          out_dir = os.path.join(root, "public")

          if os.path.isdir(out_dir):
              shutil.rmtree(out_dir)
          os.makedirs(out_dir, exist_ok=True)

          with zipfile.ZipFile(zip_path, "r") as z:
              # Extract all first
              z.extractall(out_dir)

          # Find dashboard folder
          dashboard_folder = None
          for entry in os.listdir(out_dir):
              path = os.path.join(out_dir, entry)
              if os.path.isdir(path) and "dashboard" in entry.lower():
                  dashboard_folder = path
                  break

          if not dashboard_folder:
              print("ERROR: No dashboard folder found inside ZIP")
              sys.exit(3)

          # Move dashboard contents to root of public
          for name in os.listdir(dashboard_folder):
              src = os.path.join(dashboard_folder, name)
              dst = os.path.join(out_dir, name)
              if os.path.exists(dst):
                  if os.path.isdir(dst): shutil.rmtree(dst)
                  else: os.remove(dst)
              shutil.move(src, dst)
          shutil.rmtree(dashboard_folder)

          # Final check
          if not os.path.isfile(os.path.join(out_dir, "index.html")):
              print("ERROR: index.html missing after extraction")
              sys.exit(4)
          print("âœ… Dashboard app ready in public/")

          PY

      - name: Final public check
        run: |
          echo "Final public listing:"
          ls -la public | sed -n '1,200p' || true
          if [ -f public/index.html ]; then
            echo "âœ… index.html present"
          else
            echo "âŒ index.html missing; aborting"
            exit 6

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
